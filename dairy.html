<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digital Diary - Professional Edition</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Quill -->
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f6f7fb; margin:0; padding:0; }
    .container-main { max-width:1100px; margin:24px auto; }
    .diary-header { display:flex; align-items:center; gap:12px; justify-content:space-between; margin-bottom:12px; }
    #pagedEntryContent { min-height:360px; border-radius:8px; overflow:hidden; background:#fff; box-shadow:0 6px 18px rgba(15,23,42,0.06); }
    .canvas-wrap { background:#fff; border-top:1px solid #eee; padding:12px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    #drawCanvas { border:1px solid #e6e9ef; border-radius:6px; touch-action: none; background:#fff; }
    .small-muted { color:#6c757d; font-size:0.9rem; }
    .btn-ghost { background:transparent; border:1px solid rgba(0,0,0,0.06); }
    .diary-actions { display:flex; gap:8px; align-items:center; }
    .date-display { font-weight:600; font-size:1.05rem; }
    @media (max-width:800px){ .diary-header { flex-direction:column; align-items:flex-start; gap:8px; } .canvas-wrap{flex-direction:column;} }
  </style>
</head>
<body>
  <div class="container-main">
    <div class="diary-header">
      <div>
        <div class="small-muted">User:</div>
        <div id="userIdDisplay" class="date-display">Not signed in</div>
      </div>

      <div class="diary-actions">
        <div class="btn-group" role="group" aria-label="date nav">
          <button id="prevPageBtn" class="btn btn-outline-primary btn-sm"><i class="fas fa-arrow-left"></i></button>
          <button id="todayBtn" class="btn btn-outline-secondary btn-sm">Today</button>
          <button id="nextPageBtn" class="btn btn-outline-primary btn-sm"><i class="fas fa-arrow-right"></i></button>
        </div>

        <div class="ms-2">
          <input id="datePicker" type="date" class="form-control form-control-sm" />
        </div>

        <div class="ms-2">
          <button id="saveBtn" class="btn btn-primary btn-sm"><i class="fas fa-save me-1"></i> Save</button>
          <button id="deleteBtn" class="btn btn-danger btn-sm"><i class="fas fa-trash me-1"></i> Delete</button>
        </div>
      </div>
    </div>

    <div id="pagedEntryContent" class="mb-3">
      <!-- Quill Editor -->
      <div id="editorToolbar" style="background:#fafafa; border-bottom:1px solid #eee; padding:.5rem;">
        <span class="ql-formats">
          <button class="ql-bold"></button>
          <button class="ql-italic"></button>
          <button class="ql-underline"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-list" value="bullet"></button>
          <button class="ql-list" value="ordered"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-clean"></button>
        </span>
      </div>
      <div id="editor" style="height:300px;"></div>

      <!-- Canvas area for sketches / codes -->
      <div class="canvas-wrap">
        <div style="flex:1 1 520px; min-width:260px;">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="small-muted">Sketch / Handwritten notes</div>
            <div>
              <button id="drawToggleBtn" class="btn btn-sm btn-ghost"><i class="fas fa-pen"></i> Draw</button>
              <button id="clearCanvasBtn" class="btn btn-sm btn-ghost"><i class="fas fa-eraser"></i> Clear</button>
              <button id="saveImageBtn" class="btn btn-sm btn-ghost"><i class="fas fa-download"></i> Export</button>
            </div>
          </div>
          <canvas id="drawCanvas" width="760" height="240"></canvas>
        </div>

        <div style="width:240px; min-width:200px;">
          <div class="small-muted mb-2">Quick code snippet (plain text)</div>
          <textarea id="codeBox" class="form-control" style="height:200px; font-family:monospace; font-size:0.9rem;" placeholder="// Paste code or notes here"></textarea>
          <div class="small-muted mt-2">Saved sketch and editor content are stored per date.</div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center">
      <div class="small-muted">Entries are saved to your Firebase Realtime Database under /diary/{uid}/{YYYY-MM-DD}</div>
      <div>
        <button id="signAnonBtn" class="btn btn-outline-secondary btn-sm">Sign in anonymously</button>
      </div>
    </div>
  </div>

  <!-- Modals (Summary & Confirm) -->
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <p id="confirmText" class="mb-3">Confirm?</p>
          <div class="d-flex justify-content-center gap-2">
            <button id="confirmYes" class="btn btn-danger btn-sm">Yes</button>
            <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">No</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, set, get, remove, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCLb8Fcl_Yqqd0EYXciu5wbrAj7-mz1o9M",
      authDomain: "officetools-629fc.firebaseapp.com",
      databaseURL: "https://officetools-629fc-default-rtdb.firebaseio.com",
      projectId: "officetools-629fc",
      storageBucket: "officetools-629fc.firebasestorage.app",
      messagingSenderId: "888485297465",
      appId: "1:888485297465:web:f832733b7b78d361067ce8",
      measurementId: "G-8QE15667LC"
    };

    // Initialize Firebase & expose short handles
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    window.FB = { db, auth, signInAnonymously, onAuthStateChanged, ref, set, get, remove, onValue };

    // UI refs
    const userIdDisplay = document.getElementById('userIdDisplay');
    const datePicker = document.getElementById('datePicker');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    const todayBtn = document.getElementById('todayBtn');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const signAnonBtn = document.getElementById('signAnonBtn');

    const editorContainer = document.getElementById('editor');
    const codeBox = document.getElementById('codeBox');
    const drawCanvas = document.getElementById('drawCanvas');
    const drawToggleBtn = document.getElementById('drawToggleBtn');
    const clearCanvasBtn = document.getElementById('clearCanvasBtn');
    const saveImageBtn = document.getElementById('saveImageBtn');

    // Quill editor
    let Quill;
    async function loadQuill() {
      if (!window.Quill) {
        await import('https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js');
      }
      Quill = window.Quill;
      window.quill = new Quill('#editor', {
        modules: { toolbar: '#editorToolbar' },
        theme: 'snow'
      });
    }

    // Canvas drawing basic implementation
    const ctx = drawCanvas.getContext('2d');
    let drawing = false;
    let drawEnabled = true;
    let last = { x: 0, y: 0 };
    let strokes = [];

    function resizeCanvasForDevice() {
      // keep logical size but scale for devicePixelRatio for sharpness
      const ratio = window.devicePixelRatio || 1;
      const w = 760;
      const h = 240;
      drawCanvas.style.width = w + 'px';
      drawCanvas.style.height = h + 'px';
      drawCanvas.width = Math.round(w * ratio);
      drawCanvas.height = Math.round(h * ratio);
      ctx.scale(ratio, ratio);
      redrawAll();
    }

    function startStroke(x,y) {
      drawing = true;
      last = { x, y };
      strokes.push([{ x, y }]);
    }
    function moveStroke(x,y) {
      if (!drawing) return;
      const s = strokes[strokes.length - 1];
      s.push({ x, y });
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.lineWidth = 2.6;
      ctx.strokeStyle = '#0d6efd';
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(x,y);
      ctx.stroke();
      last = { x, y };
    }
    function endStroke() { drawing = false; }

    function redrawAll() {
      // clear visible canvas
      ctx.clearRect(0,0,drawCanvas.width, drawCanvas.height);
      // scale already applied; draw using logical coordinates
      for (const s of strokes) {
        if (s.length < 2) continue;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 2.6;
        ctx.strokeStyle = '#0d6efd';
        ctx.beginPath();
        ctx.moveTo(s[0].x, s[0].y);
        for (let i=1;i<s.length;i++) ctx.lineTo(s[i].x,s[i].y);
        ctx.stroke();
      }
    }

    function clientToCanvas(ev) {
      const rect = drawCanvas.getBoundingClientRect();
      const x = (ev.clientX ?? ev.touches?.[0]?.clientX) - rect.left;
      const y = (ev.clientY ?? ev.touches?.[0]?.clientY) - rect.top;
      return { x, y };
    }

    function wireCanvasEvents() {
      // Pointer events for mouse+touch
      drawCanvas.addEventListener('pointerdown', (e) => {
        if (!drawEnabled) return;
        drawCanvas.setPointerCapture(e.pointerId);
        const p = clientToCanvas(e);
        startStroke(p.x, p.y);
      });
      drawCanvas.addEventListener('pointermove', (e) => {
        if (!drawEnabled) return;
        const p = clientToCanvas(e);
        moveStroke(p.x, p.y);
      });
      drawCanvas.addEventListener('pointerup', (e) => {
        endStroke();
      });
      drawCanvas.addEventListener('pointercancel', () => endStroke());
    }

    // Date utilities
    function formatDate(dt) {
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const d = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function parseDateInput(v) {
      return v ? new Date(v + 'T00:00:00') : new Date();
    }

    // App state
    let currentDate = new Date();
    let currentUID = null;

    function setDate(date) {
      currentDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      datePicker.value = formatDate(currentDate);
      document.getElementById('pagedEntryDate')?.remove?.(); // ignore if not present
      // update header date display
      // (we show date next to userIdDisplay)
      // load entry for date
      loadEntryForDate(formatDate(currentDate));
    }

    // Firebase helpers
    function diaryRef(uid, dateStr) {
      return ref(db, `diary/${uid}/${dateStr}`);
    }

    async function loadEntryForDate(dateStr) {
      if (!currentUID) {
        showStatus('Please sign in to load diary.');
        clearEditorAndCanvas();
        return;
      }
      showStatus('Loading...');
      try {
        const snap = await get(diaryRef(currentUID, dateStr));
        if (!snap.exists()) {
          showStatus('No entry for ' + dateStr);
          clearEditorAndCanvas();
          return;
        }
        const data = snap.val();
        // load editor (we store both delta and html; prefer delta)
        if (data.quillDelta) {
          try { window.quill.setContents(data.quillDelta); } catch (e) { window.quill.root.innerHTML = data.html || ''; }
        } else {
          window.quill.root.innerHTML = data.html || '';
        }
        codeBox.value = data.code || '';
        // load canvas image if present
        if (data.canvasImage) {
          loadCanvasFromDataURL(data.canvasImage);
        } else {
          strokes = [];
          redrawAll();
        }
        showStatus('Loaded entry for ' + dateStr);
      } catch (err) {
        console.error(err);
        showStatus('Failed to load entry.');
      }
    }

    async function saveEntryForDate(dateStr) {
      if (!currentUID) {
        showStatus('Sign in first to save.');
        return;
      }
      try {
        const delta = window.quill.getContents();
        const html = window.quill.root.innerHTML;
        const codeText = codeBox.value || '';
        const canvasImage = drawCanvas.toDataURL('image/png');
        const payload = {
          quillDelta: delta,
          html,
          code: codeText,
          canvasImage,
          updatedAt: Date.now()
        };
        await set(diaryRef(currentUID, dateStr), payload);
        showStatus('Saved ' + dateStr);
      } catch (err) {
        console.error(err);
        showStatus('Save failed.');
      }
    }

    async function deleteEntryForDate(dateStr) {
      if (!currentUID) {
        showStatus('Sign in first.');
        return;
      }
      try {
        await remove(diaryRef(currentUID, dateStr));
        showStatus('Deleted ' + dateStr);
        clearEditorAndCanvas();
      } catch (err) {
        console.error(err);
        showStatus('Delete failed.');
      }
    }

    function loadCanvasFromDataURL(dataUrl) {
      const img = new Image();
      img.onload = () => {
        // reset strokes (we won't be able to reconstruct strokes from image; just draw image)
        strokes = [];
        // scale image into canvas logical size
        ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
        // draw with CSS size coordinates; earlier ctx scaled by devicePixelRatio so use CSS size
        const cssW = parseFloat(getComputedStyle(drawCanvas).width);
        const cssH = parseFloat(getComputedStyle(drawCanvas).height);
        ctx.drawImage(img, 0, 0, cssW, cssH);
      };
      img.src = dataUrl;
    }

    function exportCanvasImage() {
      const url = drawCanvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = `diary-${formatDate(currentDate)}.png`;
      a.click();
    }

    function clearEditorAndCanvas() {
      try { window.quill.setContents([{ insert: '\n' }]); } catch (e) { window.quill.root.innerHTML = ''; }
      codeBox.value = '';
      strokes = [];
      redrawAll();
    }

    function showStatus(txt) {
      // small transient status using userIdDisplay as area, then restore UID text
      const original = currentUID ? `User: ${currentUID}` : 'Not signed in';
      userIdDisplay.textContent = txt;
      setTimeout(()=> {
        userIdDisplay.textContent = currentUID ? `User: ${currentUID}` : original;
      }, 2500);
    }

    // Wire UI
    prevBtn.addEventListener('click', () => {
      const d = new Date(currentDate);
      d.setDate(d.getDate() - 1);
      setDate(d);
    });
    nextBtn.addEventListener('click', () => {
      const d = new Date(currentDate);
      d.setDate(d.getDate() + 1);
      setDate(d);
    });
    todayBtn.addEventListener('click', () => setDate(new Date()));
    datePicker.addEventListener('change', () => setDate(parseDateInput(datePicker.value)));

    saveBtn.addEventListener('click', async () => {
      saveBtn.disabled = true;
      await saveEntryForDate(formatDate(currentDate));
      saveBtn.disabled = false;
    });

    deleteBtn.addEventListener('click', () => {
      const cm = new bootstrap.Modal(document.getElementById('confirmModal'));
      document.getElementById('confirmText').textContent = `Delete entry for ${formatDate(currentDate)}?`;
      document.getElementById('confirmYes').onclick = async () => {
        await deleteEntryForDate(formatDate(currentDate));
        cm.hide();
      };
      cm.show();
    });

    signAnonBtn.addEventListener('click', async () => {
      try {
        await signInAnonymously(auth);
      } catch (err) {
        console.error('Anonymous sign-in failed', err);
        showStatus('Sign-in failed');
      }
    });

    drawToggleBtn.addEventListener('click', () => {
      drawEnabled = !drawEnabled;
      drawToggleBtn.classList.toggle('btn-primary', drawEnabled);
      drawToggleBtn.classList.toggle('btn-ghost', !drawEnabled);
      drawToggleBtn.textContent = drawEnabled ? 'Draw' : 'View';
    });
    clearCanvasBtn.addEventListener('click', () => { strokes = []; redrawAll(); });
    saveImageBtn.addEventListener('click', exportCanvasImage);

    // Auth handling
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUID = user.uid;
        userIdDisplay.textContent = `User: ${currentUID}`;
        // expose for other scripts
        window.FIREBASE_USER_UID = currentUID;
        window.RTDB = db;
        // load today's entry
        setDate(currentDate);
      } else {
        currentUID = null;
        userIdDisplay.textContent = 'Not signed in';
        window.FIREBASE_USER_UID = null;
      }
    });

    // Boot sequence
    (async function init() {
      await loadQuill();
      resizeCanvasForDevice();
      wireCanvasEvents();
      // init date picker to today
      setDate(new Date());
      // respond to window resize to maintain crisp canvas
      window.addEventListener('resize', () => {
        resizeCanvasForDevice();
      });
      // quick hint: try to restore UID from localStorage (if any)
      const storedUID = localStorage.getItem('userUID');
      if (storedUID) {
        // no direct sign-in; but set and try to load if possible
        currentUID = storedUID;
        userIdDisplay.textContent = `User: ${currentUID}`;
      }
      // Auto anonymous sign-in if not signed in
      try {
        if (!auth.currentUser) await signInAnonymously(auth);
      } catch (err) {
        console.warn('Auto anonymous sign-in failed', err);
      }
    })();

    // Expose quick helpers for debugging
    window.diary = {
      save: () => saveEntryForDate(formatDate(currentDate)),
      load: (d) => loadEntryForDate(d || formatDate(currentDate)),
      exportCanvas: exportCanvasImage
    };
  </script>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>